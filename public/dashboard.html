<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | CONSTANTLY CODING LLC</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background:#0d1117; color:white; margin:0; padding:0;}
header { background:#161b22; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;}
header h1 { font-size:1.5rem; color:#38bdf8; margin:0; }
header button { background:#38bdf8; border:none; padding:8px 14px; border-radius:6px; font-weight:bold; cursor:pointer; color:#0d1117; margin-left:8px;}
header button:hover { background:#0ea5e9;}
main { padding:20px; max-width:1000px; margin:0 auto;}
.card { background:#161b22; padding:15px 20px; border-radius:10px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.4);}
h2 { color:#38bdf8; margin-bottom:10px; }
ul { list-style:none; padding:0; }
li { padding:5px 0; border-bottom:1px solid #0d1117; }
.highlight { color:#22c55e; font-weight:bold; }
textarea, input[type=email], input[type=text] { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:none; outline:none;}
#quoteForm label { display:block; margin-bottom:5px;}
#quoteForm button, #sendMessageBtn { margin-top:10px; width:100%; padding:10px; border:none; border-radius:6px; background:#38bdf8; color:#0d1117; font-weight:bold; cursor:pointer;}
#quoteForm button:hover, #sendMessageBtn:hover { background:#0ea5e9;}
.total { font-weight:bold; margin-top:10px;}
</style>
</head>
<body>

<header>
<h1>Dashboard</h1>
<div>
  <button onclick="window.location.href='home.html'">üè† Home</button>
  <button id="logoutBtn">Logout</button>
</div>
</header>

<main>
<!-- User Info -->
<div class="card">
<h2>User Info</h2>
<p>Email: <span id="userEmail">Loading...</span></p>
<p>Account Created: <span id="createdAt">Loading...</span></p>
<p>Tier: <span id="userTier" class="highlight">Loading...</span></p>
</div>

<!-- Tickets -->
<div class="card">
<h2>Tickets</h2>
<ul id="ticketsList"><li>Loading tickets...</li></ul>
</div>

<!-- Purchases -->
<div class="card">
<h2>Purchases</h2>
<ul id="purchasesList"><li>Loading purchases...</li></ul>
</div>

<!-- Exclusive Device Deals -->
<div class="card">
<h2>Exclusive Device Deals</h2>
<ul id="dealsList"><li>Loading deals...</li></ul>
</div>

<!-- Store Items -->
<div class="card">
<h2>Store</h2>
<ul id="storeItems"><li>Loading store items...</li></ul>
</div>

<!-- Messaging -->
<div class="card">
<h2>Send a Message</h2>
<form id="messageForm">
<textarea name="message" placeholder="Type your message here..." required></textarea>
<button type="submit">Send Message</button>
</form>
</div>

<!-- Quote Form -->
<div class="card">
<h2>Request a Quote</h2>
<form id="quoteForm">
  <div class="section">
    <h3>Select Services</h3>
    <label><input type="checkbox" name="services" value="150"> Starter Website ($150)</label>
    <label><input type="checkbox" name="services" value="400"> 5-Page Website ($400)</label>
    <label><input type="checkbox" name="services" value="600"> Web/App Store ($600)</label>
    <label><input type="checkbox" name="services" value="100"> Home Office Setup ($100)</label>
    <label><input type="checkbox" name="services" value="250"> Small Office Network ($250)</label>
    <label><input type="checkbox" name="services" value="400"> Secure Office Network ($400)</label>
    <label><input type="checkbox" name="services" value="100"> Basic Cabling Drop ($100)</label>
    <label><input type="checkbox" name="services" value="300"> Office Wiring ($300)</label>
    <label><input type="checkbox" name="services" value="500"> Full Cabling Package ($500)</label>
    <label><input type="checkbox" name="services" value="150"> Basic Ticketing System ($150)</label>
    <label><input type="checkbox" name="services" value="300"> Internal Ticket Suite ($300)</label>
    <label><input type="checkbox" name="services" value="500"> Advanced Ticketing + Portal ($500)</label>
    <label><input type="checkbox" name="services" value="150"> Inventory Tracker Lite ($150)</label>
    <label><input type="checkbox" name="services" value="400"> Asset Suite ($400)</label>
    <label><input type="checkbox" name="services" value="600"> Smart Management Dashboard ($600)</label>
    <div class="total">Total: $<span id="totalPrice">0</span></div>
  </div>

  <div class="section">
    <h3>Your Information</h3>
    <label>Full Name:<input type="text" name="from_name" required /></label>
    <label>Email:<input type="email" name="reply_to" required /></label>
    <label>Business Name (optional):<input type="text" name="business_name" /></label>
    <label>Additional Message:<textarea name="message" placeholder="What do you need most?"></textarea></label>
  </div>

  <button type="submit">Submit Quote</button>
</form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDUAxWp7O_0mfGS82Yl3AS0qp7w_JNR5dY",
  authDomain: "customer-portal-4322c.firebaseapp.com",
  projectId: "customer-portal-4322c",
  storageBucket: "customer-portal-4322c.appspot.com",
  messagingSenderId: "934096556659",
  appId: "1:934096556659:web:50f18d5e9e851d86131006"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Redirect if not logged in
onAuthStateChanged(auth, (user) => {
  if (!user) return window.location.href = "portal.html";

  document.getElementById("userEmail").textContent = user.email;
  document.getElementById("createdAt").textContent = user.metadata.creationTime;

  const userDocRef = doc(db, "users", user.uid);

  // Real-time listener for user data
  onSnapshot(userDocRef, (docSnap) => {
    const data = docSnap.data() || {};

    // Tickets
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = data.tickets?.length
      ? data.tickets.map(t => `<li>${t}</li>`).join("")
      : "<li>No tickets yet</li>";

    // Purchases
    const purchasesList = document.getElementById("purchasesList");
    purchasesList.innerHTML = data.purchases?.length
      ? data.purchases.map(p => `<li>${p.itemName} - $${p.itemPrice} - ${p.date.toDate?.().toLocaleString()}</li>`).join("")
      : "<li>No purchases yet</li>";

    // Messages
    const messagesList = document.getElementById("messagesList");
    messagesList.innerHTML = data.messages?.length
      ? data.messages.map(m => `<li><strong>${m.from}:</strong> ${m.message}</li>`).join("")
      : "<li>No messages yet</li>";

    // Tier & Deals
    const userTierSpan = document.getElementById("userTier");
    const dealsList = document.getElementById("dealsList");
    const tier = data.tier || "Basic";
    userTierSpan.textContent = tier;
    const deals = {
      Basic: ["10% off first repair", "Free diagnostic on one device"],
      Premium: ["25% off upgrades", "Priority tickets", "Free extended warranty"],
      Elite: ["50% off new devices", "24/7 VIP Support", "Annual system health check"]
    };
    dealsList.innerHTML = (deals[tier] || ["No deals available"]).map(d => `<li>${d}</li>`).join("");
  });

  // Store items real-time
  const storeQuery = query(collection(db, "storeItems"));
  onSnapshot(storeQuery, (querySnap) => {
    const storeItemsDiv = document.getElementById("storeItems");
    storeItemsDiv.innerHTML = "";
    querySnap.forEach(docItem => {
      const item = docItem.data();
      storeItemsDiv.innerHTML += `<li>${item.name} - $${item.price} - ${item.description}</li>`;
    });
  });
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth)
    .then(() => window.location.href="portal.html")
    .catch(err => alert("Logout error: "+err.message));
});
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
emailjs.init("E9OsYJGehSyOtP6bv");

// Calculate total price
const totalPriceSpan = document.getElementById("totalPrice");
document.querySelectorAll('#quoteForm input[type="checkbox"]').forEach(cb=>{
  cb.addEventListener("change",()=>{
    let total = 0;
    document.querySelectorAll('#quoteForm input[type="checkbox"]:checked').forEach(c=>{
      total += parseInt(c.value);
    });
    totalPriceSpan.textContent = total;
  });
});

// Quote form submission
document.getElementById("quoteForm").addEventListener("submit", function(e){
  e.preventDefault();
  emailjs.sendForm("service_eh25yzg", "template_r8c8xqe", this)
    .then(()=>{alert("Quote sent to constantlycodingllc@gmail.com!"); this.reset(); totalPriceSpan.textContent="0";})
    .catch(err=>alert("Error sending quote: "+err));
});

// Message form submission
document.getElementById("messageForm").addEventListener("submit", function(e){
  e.preventDefault();
  emailjs.sendForm("service_eh25yzg", "template_r8c8xqe", this)
    .then(()=>{alert("Message sent to constantlycodingllc@gmail.com!"); this.reset();})
    .catch(err=>alert("Error sending message: "+err));
});
</script>
</body>
</html>
