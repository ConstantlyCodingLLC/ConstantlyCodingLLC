<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | CONSTANTLY CODING LLC</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background:#0d1117; color:white; margin:0; padding:0;}
header { background:#161b22; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;}
header h1 { font-size:1.5rem; color:#38bdf8; margin:0; }
header button { background:#38bdf8; border:none; padding:8px 14px; border-radius:6px; font-weight:bold; cursor:pointer; color:#0d1117; margin-left:8px;}
header button:hover { background:#0ea5e9;}
main { padding:20px; max-width:1000px; margin:0 auto;}
.card { background:#161b22; padding:15px 20px; border-radius:10px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.4);}
h2 { color:#38bdf8; margin-bottom:10px; }
ul { list-style:none; padding:0; }
li { padding:5px 0; border-bottom:1px solid #0d1117; }
.highlight { color:#22c55e; font-weight:bold; }
textarea, input[type=email], input[type=text], select { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:none; outline:none;}
#quoteForm label { display:block; margin-bottom:5px;}
#quoteForm button, #sendMessageBtn { margin-top:10px; width:100%; padding:10px; border:none; border-radius:6px; background:#38bdf8; color:#0d1117; font-weight:bold; cursor:pointer;}
#quoteForm button:hover, #sendMessageBtn:hover { background:#0ea5e9;}
.total { font-weight:bold; margin-top:10px;}
</style>
</head>
<body>

<header>
<h1>Dashboard</h1>
<div>
  <button onclick="window.location.href='home.html'">üè† Home</button>
  <button id="logoutBtn">Logout</button>
</div>
</header>

<main>
<!-- User Info -->
<div class="card">
<h2>User Info</h2>
<p>Email: <span id="userEmail">Loading...</span></p>
<p>Account Created: <span id="createdAt">Loading...</span></p>
<p>Tier: <span id="userTier" class="highlight">Loading...</span></p>

<label for="tierSelect">Choose Your Tier:</label>
<select id="tierSelect">
  <option value="1.05">Bronze (+5%)</option>
  <option value="1.10">Silver (+10%)</option>
  <option value="1.15">Gold (+15%)</option>
</select>
</div>

<!-- Tickets -->
<div class="card">
<h2>Tickets</h2>
<ul id="ticketsList"><li>Loading tickets...</li></ul>
</div>

<!-- Purchases -->
<div class="card">
<h2>Purchases</h2>
<ul id="purchasesList"><li>Loading purchases...</li></ul>
</div>

<!-- Exclusive Device Deals -->
<div class="card">
<h2>Exclusive Device Deals</h2>
<ul id="dealsList"><li>Loading deals...</li></ul>
</div>

<!-- Store Items -->
<div class="card">
<h2>Store</h2>
<ul id="storeItems"><li>Loading store items...</li></ul>
</div>

<!-- Messaging -->
<div class="card">
<h2>Send a Message</h2>
<form id="messageForm">
<textarea name="message" placeholder="Type your message here..." required></textarea>
<button type="submit">Send Message</button>
</form>
</div>

<!-- Quote Form -->
<div class="card">
<h2>Request a Quote</h2>
<form id="quoteForm">
  <div class="section">
    <h3>Select Services</h3>
    <label><input type="checkbox" class="serviceItem" data-base="150"> Starter Website ($150)</label>
    <label><input type="checkbox" class="serviceItem" data-base="400"> 5-Page Website ($400)</label>
    <label><input type="checkbox" class="serviceItem" data-base="600"> Web/App Store ($600)</label>
    <label><input type="checkbox" class="serviceItem" data-base="100"> Home Office Setup ($100)</label>
    <label><input type="checkbox" class="serviceItem" data-base="250"> Small Office Network ($250)</label>
    <label><input type="checkbox" class="serviceItem" data-base="400"> Secure Office Network ($400)</label>
    <label><input type="checkbox" class="serviceItem" data-base="100"> Basic Cabling Drop ($100)</label>
    <label><input type="checkbox" class="serviceItem" data-base="300"> Office Wiring ($300)</label>
    <label><input type="checkbox" class="serviceItem" data-base="500"> Full Cabling Package ($500)</label>
    <label><input type="checkbox" class="serviceItem" data-base="150"> Basic Ticketing System ($150)</label>
    <label><input type="checkbox" class="serviceItem" data-base="300"> Internal Ticket Suite ($300)</label>
    <label><input type="checkbox" class="serviceItem" data-base="500"> Advanced Ticketing + Portal ($500)</label>
    <label><input type="checkbox" class="serviceItem" data-base="150"> Inventory Tracker Lite ($150)</label>
    <label><input type="checkbox" class="serviceItem" data-base="400"> Asset Suite ($400)</label>
    <label><input type="checkbox" class="serviceItem" data-base="600"> Smart Management Dashboard ($600)</label>
    <div class="total">Total: $<span id="totalPrice">0</span></div>
  </div>

  <div class="section">
    <h3>Your Information</h3>
    <label>Full Name:<input type="text" name="from_name" required /></label>
    <label>Email:<input type="email" name="reply_to" required /></label>
    <label>Business Name (optional):<input type="text" name="business_name" /></label>
    <label>Additional Message:<textarea name="message" placeholder="What do you need most?"></textarea></label>
  </div>

  <button type="submit">Submit Quote</button>
</form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDUAxWp7O_0mfGS82Yl3AS0qp7w_JNR5dY",
  authDomain: "customer-portal-4322c.firebaseapp.com",
  projectId: "customer-portal-4322c",
  storageBucket: "customer-portal-4322c.appspot.com",
  messagingSenderId: "934096556659",
  appId: "1:934096556659:web:50f18d5e9e851d86131006"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const tierSelect = document.getElementById("tierSelect");
const totalPriceSpan = document.getElementById("totalPrice");
const serviceCheckboxes = document.querySelectorAll(".serviceItem");

// Update total price based on selected tier
function updateTotal() {
  const multiplier = parseFloat(tierSelect.value);
  let total = 0;
  serviceCheckboxes.forEach(cb => { 
    if(cb.checked) total += Math.round(parseFloat(cb.dataset.base) * multiplier); 
  });
  totalPriceSpan.textContent = total;
}

// Firebase user real-time data
onAuthStateChanged(auth, (user) => {
  if (!user) return window.location.href = "portal.html";

  const userDocRef = doc(db, "users", user.uid);

  document.getElementById("userEmail").textContent = user.email;
  document.getElementById("createdAt").textContent = user.metadata.creationTime;

  onSnapshot(userDocRef, (docSnap) => {
    const data = docSnap.data() || {};
    document.getElementById("userTier").textContent = data.tier || "Basic";

    // Set tier selector based on stored user tier
    if(data.tier){
      switch(data.tier.toLowerCase()){
        case "bronze": tierSelect.value = "1.05"; break;
        case "silver": tierSelect.value = "1.10"; break;
        case "gold": tierSelect.value = "1.15"; break;
        default: tierSelect.value = "1.05";
      }
    }

    // Tickets
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = data.tickets?.length
      ? data.tickets.map(t => `<li>${t}</li>`).join("")
      : "<li>No tickets yet</li>";

    // Purchases
    const purchasesList = document.getElementById("purchasesList");
    purchasesList.innerHTML = data.purchases?.length
      ? data.purchases.map(p => `<li>${p.itemName} - $${p.itemPrice}</li>`).join("")
      : "<li>No purchases yet</li>";

    // Deals
    const dealsList = document.getElementById("dealsList");
    const deals = {
      bronze: ["5% off first purchase", "Basic support"],
      silver: ["10% off upgrades", "Priority support"],
      gold: ["15% off new devices", "24/7 VIP Support"]
    };
    dealsList.innerHTML = (deals[(data.tier||"bronze").toLowerCase()] || []).map(d => `<li>${d}</li>`).join("");
    
    updateTotal();
  });

  // Store items
  const storeQuery = query(collection(db, "storeItems"));
  onSnapshot(storeQuery, (querySnap) => {
    const storeItemsDiv = document.getElementById("storeItems");
    storeItemsDiv.innerHTML = "";
    querySnap.forEach(docItem => {
      const item = docItem.data();
      storeItemsDiv.innerHTML += `<li>${item.name} - $${item.price} - ${item.description}</li>`;
    });
  });
});

tierSelect.addEventListener("change", updateTotal);
serviceCheckboxes.forEach(cb => cb.addEventListener("change", updateTotal));

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth).then(()=>window.location.href="portal.html").catch(err=>alert("Logout error: "+err.message));
});
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
emailjs.init("E9OsYJGehSyOtP6bv");

// Quote form
document.getElementById("quoteForm").addEventListener("submit", function(e){
  e.preventDefault();
  emailjs.sendForm("service_eh25yzg", "template_r8c8xqe", this)
    .then(()=>{alert("Quote sent!"); this.reset(); totalPriceSpan.textContent="0";})
    .catch(err=>alert("Error sending quote: "+err));
});

// Message form
document.getElementById("messageForm").addEventListener("submit", function(e){
  e.preventDefault();
  emailjs.sendForm("service_eh25yzg", "template_r8c8xqe", this)
    .then(()=>{alert("Message sent!"); this.reset();})
    .catch(err=>alert("Error sending message: "+err));
});
</script>
</body>
</html>
